<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>STADY DASH: NPC EDITION</title>
    <style>
        :root { --main: #cba6f7; --bg: #0b0b10; --danger: #f38ba8; --accent: #a6e3a1; }
        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            overflow: hidden; background: var(--bg);
            font-family: 'Segoe UI', sans-serif; color: white; user-select: none;
            touch-action: none;
        }
        canvas { display: block; width: 100%; height: 100%; }
        .overlay { position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; z-index: 1000; background: rgba(11, 11, 16, 0.95); backdrop-filter: blur(15px); }
        .panel { background: #181825; padding: 25px; border-radius: 24px; border: 2px solid var(--main); text-align: center; width: 85%; max-width: 420px; box-sizing: border-box; }
        .title { font-size: 2rem; font-weight: 900; color: var(--main); margin-bottom: 15px; }
        .start-btn { background: var(--main); color: #11111b; border: none; padding: 12px 30px; font-size: 1.2rem; font-weight: bold; border-radius: 12px; cursor: pointer; width: 100%; }
        .level-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 20px; max-height: 180px; overflow-y: auto; }
        .lvl-btn { background: #313244; border: 1px solid var(--main); color: white; aspect-ratio: 1; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .stats-box { position: fixed; top: 20px; left: 20px; z-index: 100; background: rgba(0,0,0,0.6); padding: 10px; border-radius: 12px; border: 1px solid var(--main); pointer-events: none; }
        .controls { position: fixed; bottom: 40px; left: 0; width: 100%; display: flex; justify-content: space-between; padding: 0 30px; box-sizing: border-box; z-index: 500; pointer-events: none; }
        .btn-zone { pointer-events: auto; touch-action: none; }
        .btn { width: 70px; height: 70px; background: rgba(255,255,255,0.1); border-radius: 18px; display: flex; align-items: center; justify-content: center; color: white; font-size: 2rem; border: 2px solid rgba(255,255,255,0.2); }
        .btn-jump { border-radius: 50%; border-color: var(--main); width: 85px; height: 85px; background: rgba(203, 166, 247, 0.1); }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <canvas id="game"></canvas>

    <div id="menu" class="overlay">
        <div class="panel">
            <div class="title">STADY DASH</div>
            <button class="start-btn" id="mainStartBtn">ПРОДОЛЖИТЬ</button>
            <div class="level-grid" id="lvlGrid"></div>
        </div>
    </div>

    <div class="stats-box">
        <div id="lvlDisplay">ЭТАЖ: 1/32</div>
        <div id="attemptDisplay" style="color: var(--danger); font-size: 0.8rem;">ПОПЫТКА: 1</div>
    </div>

    <div class="controls">
        <div style="display:flex; gap:15px;">
            <div id="lBtn" class="btn-zone"><div class="btn">←</div></div>
            <div id="rBtn" class="btn-zone"><div class="btn">→</div></div>
        </div>
        <div id="jBtn" class="btn-zone"><div class="btn btn-jump">↑</div></div>
    </div>

<script>
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    const pImg = new Image(); pImg.src = 'player.jpg';
    const npcImg = new Image(); npcImg.src = 'npc.png'; // Наш файл для NPC
    const bgImg = new Image();
    const musics = [new Audio('music.mp3'), new Audio('music2.mp3')];
    musics.forEach(m => m.loop = true);
    
    let isPlaying = false, currentLvl = 0, attempts = 1, frame = 0;
    let cameraX = 0, cameraY = 0, zoom = 1.0;
    const fps = 60;
    const interval = 1000 / fps;
    let lastTime = 0;

    const player = { x: 100, y: 400, w: 42, h: 42, vx: 0, vy: 0, speed: 8.5, jump: -23.5, ground: false, angle: 0, coyoteTime: 0 };
    const input = { left: false, right: false, up: false };
    let levelData = { p: [], g: [0,0], s: [], l: [], npcs: [] };

    function generateLevel(idx) {
        const len = 5000 + (idx * 400);
        const p = [{x: 0, y: 600, w: 600, h: 400, move: false}];
        const s = [], l = [], npcs = [];
        let lx = 600, ly = 600;
        
        while(lx < len - 900) {
            lx += 230 + Math.random() * 100;
            ly = Math.max(250, Math.min(1100, ly + (Math.random() - 0.5) * 260));
            const isMoving = Math.random() > 0.75;
            const w = 280 + Math.random() * 80;
            const platform = { x: lx, y: ly, w: w, h: 50, move: isMoving, offset: Math.random() * 10, range: 85, baseY: ly };
            p.push(platform);
            
            if(!isMoving) {
                if(Math.random() > 0.75) s.push({ x: lx + 60, y: ly - 25, w: 50, h: 25 });
                if(Math.random() > 0.55) {
                    npcs.push({ 
                        x: lx + 20, y: ly - 40, w: 35, h: 40, 
                        parent: platform, relX: 20 + Math.random() * (w-70), 
                        dir: Math.random() > 0.5 ? 1 : -1, 
                        speed: 1.5 + Math.random() * 1.5 
                    });
                }
            } else if(Math.random() > 0.85) {
                l.push({ x: lx + w/2 - 10, y: ly - 220, w: 20, h: 220 });
            }
            lx += w;
        }
        p.push({x: len - 700, y: ly, w: 700, h: 500, move: false});
        return { p, s, l, npcs, g: [len - 150, ly] };
    }

    const grid = document.getElementById('lvlGrid');
    for(let i=0; i < 32; i++) {
        const btn = document.createElement('button');
        btn.className = 'lvl-btn'; btn.innerText = i + 1;
        btn.onclick = () => { currentLvl = i; startGame(); };
        grid.appendChild(btn);
    }

    const bindTouch = (id, key) => {
        const el = document.getElementById(id);
        el.addEventListener('touchstart', (e) => { e.preventDefault(); input[key] = true; }, {passive: false});
        el.addEventListener('touchend', (e) => { e.preventDefault(); input[key] = false; }, {passive: false});
    };
    bindTouch('lBtn', 'left'); bindTouch('rBtn', 'right'); bindTouch('jBtn', 'up');

    function reset() {
        player.x = 100; player.y = 400; player.vx = 0; player.vy = 0; player.angle = 0;
        levelData.npcs.forEach(n => n.x = n.parent.x + n.relX);
        document.getElementById('attemptDisplay').innerText = `ПОПЫТКА: ${attempts}`;
        document.getElementById('lvlDisplay').innerText = `ЭТАЖ: ${currentLvl+1}/32`;
    }

    function startGame() {
        bgImg.src = `back (${Math.floor(Math.random() * 32) + 1}).jpg`;
        musics.forEach(m => m.pause());
        musics[currentLvl % 2].play().catch(() => {});
        levelData = generateLevel(currentLvl);
        reset();
        document.getElementById('menu').classList.add('hidden');
        if(!isPlaying) { isPlaying = true; requestAnimationFrame(loop); }
    }

    document.getElementById('mainStartBtn').onclick = startGame;

    function loop(now) {
        if(!isPlaying) return;
        requestAnimationFrame(loop);
        const delta = now - lastTime;
        if (delta < interval) return;
        lastTime = now - (delta % interval);
        frame++;
        const laserOn = (frame % 130) < 70;

        if (player.ground) player.coyoteTime = 8;
        else if (player.coyoteTime > 0) player.coyoteTime--;
        if (input.up && player.coyoteTime > 0) { player.vy = player.jump; player.ground = false; player.coyoteTime = 0; }

        player.vx = input.left ? -player.speed : (input.right ? player.speed : 0);
        player.vy += 1.0; player.x += player.vx; player.y += player.vy;
        if(!player.ground) player.angle += 0.22; else player.angle = 0;

        player.ground = false;
        levelData.p.forEach(p => {
            if(p.move) p.y = p.baseY + Math.sin(frame * 0.05 + p.offset) * p.range;
            if(player.x+player.w > p.x && player.x < p.x+p.w && player.y+player.h > p.y && player.y+player.h < p.y+40 && player.vy >= 0) {
                player.y = p.y-player.h; player.vy = 0; player.ground = true;
            }
        });

        levelData.npcs.forEach(n => {
            n.relX += n.dir * n.speed;
            if(n.relX < 0 || n.relX > n.parent.w - n.w) n.dir *= -1;
            n.x = n.parent.x + n.relX;
            n.y = n.parent.y - n.h + Math.abs(Math.sin(frame * 0.1)) * -4;
        });

        levelData.s.forEach(s => { if(player.x+player.w > s.x+10 && player.x < s.x+s.w-10 && player.y+player.h > s.y+5 && player.y < s.y+s.h) { attempts++; reset(); } });
        if(laserOn) levelData.l.forEach(l => { if(player.x+player.w > l.x && player.x < l.x+l.w && player.y+player.h > l.y && player.y < l.y+l.h) { attempts++; reset(); } });
        if(player.y > 3000) { attempts++; reset(); }
        if(player.x > levelData.g[0]) { currentLvl++; if(currentLvl >= 32) { isPlaying = false; document.getElementById('menu').classList.remove('hidden'); } else startGame(); }

        let nextP = levelData.p.find(p => p.x > player.x && p.x < player.x + 650);
        let targetY = player.y, targetZoom = 1.0;
        if (nextP) { targetY = (player.y + nextP.y) / 2; targetZoom = Math.max(0.6, 1.0 - (Math.abs(player.y - nextP.y) / 1300)); }
        zoom += (targetZoom - zoom) * 0.05;
        cameraX += (player.x - (canvas.width/zoom) * 0.25 - cameraX) * 0.1;
        cameraY += (targetY - (canvas.height/zoom) * 0.6 - cameraY) * 0.08;

        draw(laserOn);
    }

    function draw(laserOn) {
        const w = canvas.width, h = canvas.height;
        ctx.setTransform(1,0,0,1,0,0);
        ctx.fillStyle = '#0b0b10'; ctx.fillRect(0,0,w,h);
        
        ctx.save();
        ctx.translate(w/2, h/2); ctx.scale(zoom, zoom); ctx.translate(-w/2, -h/2);
        let bgX = -(cameraX * 0.2) % w, bgY = -(cameraY * 0.2) % h;
        ctx.globalAlpha = 0.4;
        for(let i = -1; i <= 1; i++) for(let j = -1; j <= 1; j++) ctx.drawImage(bgImg, bgX + i * w, bgY + j * h, w, h);
        ctx.restore();

        ctx.save();
        ctx.translate(w/2, h/2); ctx.scale(zoom, zoom); ctx.translate(-w/2, -h/2);
        ctx.translate(-cameraX, -cameraY);
        
        levelData.p.forEach(p => {
            ctx.fillStyle = p.move ? '#24283b' : '#1e1e2e'; ctx.fillRect(p.x, p.y, p.w, p.h);
            ctx.strokeStyle = '#cba6f7'; ctx.lineWidth = 2; ctx.strokeRect(p.x, p.y, p.w, p.h);
        });

        ctx.fillStyle = '#f38ba8';
        levelData.s.forEach(s => { ctx.beginPath(); ctx.moveTo(s.x, s.y + s.h); ctx.lineTo(s.x + s.w / 2, s.y); ctx.lineTo(s.x + s.w, s.y + s.h); ctx.fill(); });

        levelData.l.forEach(l => {
            ctx.fillStyle = laserOn ? 'rgba(243, 139, 168, 0.7)' : 'rgba(243, 139, 168, 0.1)';
            ctx.fillRect(l.x, l.y, l.w, l.h);
            if(laserOn) { ctx.shadowBlur = 15; ctx.shadowColor = '#f38ba8'; ctx.fillRect(l.x + l.w/2 - 2, l.y, 4, l.h); ctx.shadowBlur = 0; }
        });

        // ОТРИСОВКА NPC (с разворотом спрайта)
        levelData.npcs.forEach(n => {
            ctx.save();
            ctx.translate(n.x + n.w/2, n.y + n.h/2);
            if(n.dir < 0) ctx.scale(-1, 1); // Зеркалим, если идет влево
            ctx.drawImage(npcImg, -n.w/2, -n.h/2, n.w, n.h);
            ctx.restore();
        });

        ctx.fillStyle = '#a6e3a1'; ctx.shadowBlur = 20; ctx.shadowColor = '#a6e3a1';
        ctx.fillRect(levelData.g[0], levelData.g[1]-120, 60, 120); ctx.shadowBlur = 0;
        
        ctx.save(); ctx.translate(player.x + player.w/2, player.y + player.h/2); ctx.rotate(player.angle);
        ctx.drawImage(pImg, -player.w/2, -player.h/2, player.w, player.h); ctx.restore();

        ctx.restore();
    }
    window.onresize = () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; };
    window.onresize();
</script>
</body>
</html>
