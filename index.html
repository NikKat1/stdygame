<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>–•–ê–ô–ü-–ö–í–ï–°–¢: –†–ê–ù–î–û–ú ‚ú®</title>
    <style>
        :root { --main: #cba6f7; --bg: #0b0b10; --danger: #f38ba8; }
        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            overflow: hidden; background: var(--bg);
            font-family: 'Segoe UI', sans-serif; color: white; user-select: none;
        }
        canvas { display: block; width: 100%; height: 100%; touch-action: none; }
        
        .overlay { 
            position: fixed; inset: 0; display: flex; align-items: center; 
            justify-content: center; z-index: 1000; 
            background: rgba(0,0,0,0.85); backdrop-filter: blur(8px);
        }
        .panel { 
            background: #181825; padding: 25px; border-radius: 20px; 
            border: 2px solid var(--main); text-align: center; width: 85%; max-width: 400px;
        }
        .level-grid { 
            display: grid; grid-template-columns: repeat(5, 1fr); 
            gap: 8px; margin: 15px 0; max-height: 200px; overflow-y: auto; padding: 5px;
        }
        .lvl-btn { 
            background: #313244; border: 1px solid var(--main); 
            color: white; aspect-ratio: 1; border-radius: 8px; font-weight: bold; cursor: pointer;
        }

        .stats-box { 
            position: fixed; top: env(safe-area-inset-top, 20px); left: 20px; z-index: 100;
            background: rgba(0,0,0,0.6); padding: 10px 15px; border-radius: 12px; 
            border: 1px solid var(--main); pointer-events: none;
        }
        
        .controls { 
            position: fixed; 
            bottom: calc(env(safe-area-inset-bottom, 20px) + 60px);
            left: 0; width: 100%; 
            display: flex; justify-content: space-between; 
            padding: 0 30px; box-sizing: border-box;
            pointer-events: none; z-index: 500;
        }
        .joy-group, .jump-group { pointer-events: auto; display: flex; gap: 20px; }
        .btn { 
            width: 80px; height: 80px; 
            background: rgba(255,255,255,0.15); 
            backdrop-filter: blur(4px);
            border-radius: 20px; display: flex; align-items: center; justify-content: center; 
            color: white; font-size: 2rem; border: 2px solid rgba(255,255,255,0.3);
            touch-action: none;
        }
        .btn:active { background: var(--main); transform: scale(0.95); border-color: white; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <canvas id="game"></canvas>

    <div id="menu" class="overlay">
        <div class="panel">
            <h2 style="color: var(--main); margin: 0 0 10px 0;">–≠–¢–ê–ñ–ò ‚ú®</h2>
            <div class="level-grid" id="lvlGrid"></div>
            <button class="lvl-btn" style="width:100%; aspect-ratio:auto; padding:12px;" onclick="startGame(0)">–ù–ê–ß–ê–¢–¨ –ó–ê–ù–û–í–û üöÄ</button>
        </div>
    </div>

    <div class="stats-box">
        <div id="lvlDisplay">–≠–¢–ê–ñ: 1/32</div>
        <div id="attemptDisplay" style="color: var(--danger); font-size: 0.8rem;">–ü–û–ü–´–¢–ö–ê: 1</div>
    </div>

    <div class="controls">
        <div class="joy-group">
            <div class="btn" id="lBtn">‚Üê</div>
            <div class="btn" id="rBtn">‚Üí</div>
        </div>
        <div class="jump-group">
            <div class="btn" id="jBtn" style="border-radius: 50%; border-color: var(--main); width: 90px; height: 90px;">‚Üë</div>
        </div>
    </div>

<script>
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    
    // –†–µ—Å—É—Ä—Å—ã
    const pImg = new Image(); pImg.src = 'player.jpg';
    const bgImg = new Image();
    
    // –ó–≤—É–∫–∏
    const musics = [new Audio('music.mp3'), new Audio('music2.mp3')];
    musics.forEach(m => m.loop = true);
    
    const sndJump = new Audio('jump.wav');
    const sndFall = new Audio('fall.wav');
    const sndLoose = new Audio('loose.wav');

    const TOTAL_LEVELS = 32;
    let isPlaying = false, cameraX = 0, cameraY = 0, frame = 0, currentLvl = 0, attempts = 1;
    const player = { x: 100, y: 100, w: 50, h: 50, vx: 0, vy: 0, speed: 7, jump: -18, ground: false, angle: 0 };
    const input = { left: false, right: false, up: false };
    let npcs = [];

    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É—Ä–æ–≤–Ω–µ–π
    const levels = [];
    for(let i=0; i < TOTAL_LEVELS; i++) {
        const len = 3000 + (i * 400);
        const levelData = { width: len, p: [[0, 500, 800, 200]], l: [], s: [], npcs: [], g: [len - 150, 500] };
        for(let x = 850; x < len - 500; x += 450) {
            const y = 300 + Math.random() * 250;
            const w = 250 + Math.random() * 300;
            levelData.p.push([x, y, w, 40]);
            if(Math.random() > 0.7) levelData.l.push({ x: x + w/2 - 10, y: y - 100, w: 20, h: 100 });
            else if(Math.random() > 0.4) levelData.s.push({ x: x + 50, y: y - 20, w: 40, h: 20 });
            if(Math.random() > 0.4) levelData.npcs.push({ x: x + 20, y: y - 40, startX: x + 20, range: w - 60, dir: 1 });
        }
        levelData.p.push([len - 500, 500, 500, 200]);
        levels.push(levelData);
    }

    const grid = document.getElementById('lvlGrid');
    for(let i=0; i < TOTAL_LEVELS; i++) {
        const btn = document.createElement('button');
        btn.className = 'lvl-btn'; btn.innerText = i + 1;
        btn.onclick = () => startGame(i);
        grid.appendChild(btn);
    }

    function resize() {
        const dpr = window.devicePixelRatio || 1;
        canvas.width = window.innerWidth * dpr;
        canvas.height = window.innerHeight * dpr;
        ctx.scale(dpr, dpr);
    }
    window.addEventListener('resize', resize);
    resize();

    // –†–ê–ù–î–û–ú –§–û–ù–ê –ò –ß–ï–†–ï–î–û–í–ê–ù–ò–ï –ú–£–ó–´–ö–ò
    function updateLevelAssets(lvlIdx) { 
        // –°–ª—É—á–∞–π–Ω—ã–π —Ñ–æ–Ω –æ—Ç 1 –¥–æ 32
        const randomBgNum = Math.floor(Math.random() * 32) + 1;
        bgImg.src = `back (${randomBgNum}).jpg`; 

        // –ß–µ—Ä–µ–¥–æ–≤–∞–Ω–∏–µ –º—É–∑—ã–∫–∏: —É—Ä–æ–≤–µ–Ω—å 1 - music1, —É—Ä–æ–≤–µ–Ω—å 2 - music2, —É—Ä–æ–≤–µ–Ω—å 3 - music1...
        const musicIndex = lvlIdx % 2; 
        musics[1 - musicIndex].pause(); // –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥—Ä—É–≥—É—é
        musics[musicIndex].play().catch(() => {}); // –í–∫–ª—é—á–∏—Ç—å —Ç–µ–∫—É—â—É—é
    }

    function playSnd(audio) {
        audio.currentTime = 0;
        audio.play().catch(() => {});
    }

    function startGame(idx) {
        currentLvl = idx; attempts = 1; updateLevelAssets(idx); reset();
        document.getElementById('menu').classList.add('hidden');
        isPlaying = true; requestAnimationFrame(loop);
    }

    function reset(isDeath = false, reason = 'fall') {
        if(isDeath) {
            attempts++;
            if(reason === 'trap') playSnd(sndLoose);
            else playSnd(sndFall);
        }
        player.x = 100; player.y = 100; player.vx = 0; player.vy = 0;
        cameraX = player.x - window.innerWidth / 3;
        cameraY = player.y - window.innerHeight * 0.6;
        npcs = JSON.parse(JSON.stringify(levels[currentLvl].npcs));
        document.getElementById('attemptDisplay').innerText = `–ü–û–ü–´–¢–ö–ê: ${attempts}`;
        document.getElementById('lvlDisplay').innerText = `–≠–¢–ê–ñ: ${currentLvl+1}/${TOTAL_LEVELS}`;
    }

    const setupBtn = (id, key) => {
        const el = document.getElementById(id);
        const start = (e) => { e.preventDefault(); input[key] = true; };
        const end = (e) => { e.preventDefault(); input[key] = false; };
        el.addEventListener('touchstart', start, {passive: false});
        el.addEventListener('touchend', end, {passive: false});
        el.addEventListener('mousedown', start);
        el.addEventListener('mouseup', end);
    };
    setupBtn('lBtn', 'left'); setupBtn('rBtn', 'right'); setupBtn('jBtn', 'up');

    function loop() {
        if(!isPlaying) return;
        frame++;
        const lvl = levels[currentLvl];

        if(input.left) player.vx = -player.speed;
        else if(input.right) player.vx = player.speed;
        else player.vx *= 0.8;

        if(input.up && player.ground) { 
            player.vy = player.jump; 
            player.ground = false; 
            playSnd(sndJump);
        }
        if(!player.ground) player.angle += 0.15; else player.angle = 0;

        player.vy += 0.85; player.x += player.vx; player.y += player.vy;

        cameraX += (player.x - window.innerWidth / 3 - cameraX) * 0.1;
        cameraY += (player.y - window.innerHeight * 0.65 - cameraY) * 0.08;
        if(cameraX < 0) cameraX = 0;

        player.ground = false;
        lvl.p.forEach(p => {
            if(player.x+player.w > p[0] && player.x < p[0]+p[2] && player.y+player.h > p[1] && player.y+player.h < p[1]+30 && player.vy >= 0) {
                player.y = p[1]-player.h; player.vy = 0; player.ground = true;
            }
        });

        npcs.forEach(n => {
            n.x += n.dir * 1.5;
            if(n.x > n.startX + n.range || n.x < n.startX) n.dir *= -1;
        });

        const active = (frame % 140) < 50;
        lvl.s.forEach(s => {
            if(player.x+player.w > s.x && player.x < s.x+s.w && player.y+player.h > s.y && player.y < s.y+s.h) reset(true, 'trap');
        });
        if(active) {
            lvl.l.forEach(l => {
                if(player.x+player.w > l.x && player.x < l.x+l.w && player.y+player.h > l.y && player.y < l.y+l.h) reset(true, 'trap');
            });
        }

        if(player.x + player.w > lvl.g[0] && player.y + player.h > lvl.g[1]-100) {
            if(currentLvl < TOTAL_LEVELS - 1) { 
                currentLvl++; 
                attempts = 1; 
                updateLevelAssets(currentLvl); 
                reset(); 
            } else { alert("MAX HYPE!"); location.reload(); }
        }
        if(player.y > cameraY + window.innerHeight + 800) reset(true, 'fall');

        draw(lvl, active);
        requestAnimationFrame(loop);
    }

    function draw(lvl, active) {
        const w = window.innerWidth; const h = window.innerHeight;
        ctx.fillStyle = '#0b0b10'; ctx.fillRect(0,0,w,h);
        ctx.globalAlpha = 0.35; ctx.drawImage(bgImg, 0, 0, w, h); ctx.globalAlpha = 1;

        ctx.save();
        ctx.translate(-cameraX, -cameraY);

        ctx.fillStyle = '#1e1e2e';
        lvl.p.forEach(p => {
            ctx.fillRect(p[0], p[1], p[2], p[3]);
            ctx.strokeStyle = '#cba6f7'; ctx.lineWidth = 2; ctx.strokeRect(p[0], p[1], p[2], p[3]);
        });

        ctx.fillStyle = '#f38ba8';
        lvl.s.forEach(s => {
            ctx.beginPath(); ctx.moveTo(s.x, s.y+s.h); ctx.lineTo(s.x+s.w/2, s.y); ctx.lineTo(s.x+s.w, s.y+s.h); ctx.fill();
        });

        lvl.l.forEach(l => {
            ctx.fillStyle = active ? '#f38ba8' : 'rgba(255,255,255,0.05)';
            ctx.fillRect(l.x, l.y, l.w, l.h);
        });

        npcs.forEach(n => { ctx.drawImage(pImg, n.x, n.y, 42, 42); });
        ctx.fillStyle = '#a6e3a1'; ctx.fillRect(lvl.g[0], lvl.g[1]-100, 60, 100);

        ctx.save();
        ctx.translate(player.x+player.w/2, player.y+player.h/2);
        ctx.rotate(player.angle);
        ctx.drawImage(pImg, -player.w/2, -player.h/2, player.w, player.h);
        ctx.restore();

        ctx.restore();
    }
</script>
</body>
</html>
