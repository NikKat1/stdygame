<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>–•–ê–ô–ü-–ö–í–ï–°–¢: –≠–í–û–õ–Æ–¶–ò–Ø ‚ú®</title>
    <style>
        :root { --main: #cba6f7; --bg: #0b0b10; --danger: #f38ba8; }
        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            overflow: hidden; background: var(--bg);
            font-family: 'Segoe UI', sans-serif; color: white; user-select: none; touch-action: none;
        }
        canvas { display: block; width: 100vw; height: 100vh; }
        
        .overlay { 
            position: fixed; inset: 0; display: flex; align-items: center; 
            justify-content: center; z-index: 1000; 
            background: rgba(0,0,0,0.85); backdrop-filter: blur(8px);
        }
        .panel { 
            background: #181825; padding: 25px; border-radius: 20px; 
            border: 2px solid var(--main); text-align: center; width: 90%; max-width: 400px;
        }
        .level-grid { 
            display: grid; grid-template-columns: repeat(5, 1fr); 
            gap: 8px; margin: 15px 0; max-height: 180px; overflow-y: auto;
        }
        .lvl-btn { 
            background: #313244; border: 1px solid var(--main); 
            color: white; aspect-ratio: 1; border-radius: 8px; font-weight: bold; cursor: pointer;
        }
        .lvl-btn:active { background: var(--main); color: #111; }

        .stats-box { 
            position: fixed; top: 20px; left: 20px; z-index: 100;
            background: rgba(0,0,0,0.7); padding: 10px 20px; border-radius: 15px; 
            border: 1px solid var(--main); font-weight: bold; line-height: 1.4;
        }
        
        .controls { 
            position: fixed; bottom: 40px; left: 0; width: 100%; 
            display: flex; justify-content: space-between; padding: 0 25px; 
            pointer-events: none; z-index: 500;
        }
        .joy-group, .jump-group { pointer-events: auto; display: flex; gap: 15px; }
        .btn { 
            width: 75px; height: 75px; background: rgba(255,255,255,0.1); 
            border-radius: 18px; display: flex; align-items: center; justify-content: center; 
            color: white; font-size: 1.8rem; border: 2px solid rgba(255,255,255,0.2);
        }
        .btn:active { background: var(--main); transform: scale(0.9); }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <canvas id="game"></canvas>

    <div id="menu" class="overlay">
        <div class="panel">
            <h2 style="color: var(--main); margin: 0;">–í–´–ë–ï–†–ò –≠–¢–ê–ñ ‚ú®</h2>
            <div class="level-grid" id="lvlGrid"></div>
            <button class="lvl-btn" style="width:100%; aspect-ratio:auto; padding:12px;" onclick="startGame(0)">–ò–ì–†–ê–¢–¨ –°–ù–ê–ß–ê–õ–ê üöÄ</button>
        </div>
    </div>

    <div class="stats-box">
        <div id="lvlDisplay">–≠–¢–ê–ñ: 1/20</div>
        <div id="attemptDisplay" style="color: var(--danger); font-size: 0.9rem;">–ü–û–ü–´–¢–ö–ê: 1</div>
    </div>

    <div class="controls" id="ui">
        <div class="joy-group">
            <div class="btn" id="lBtn">‚Üê</div>
            <div class="btn" id="rBtn">‚Üí</div>
        </div>
        <div class="jump-group">
            <div class="btn" id="jBtn" style="border-radius: 50%; width: 85px; height: 85px; border-color: var(--main);">‚Üë</div>
        </div>
    </div>

<script>
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    
    const pImg = new Image(); pImg.src = 'player.jpg';
    const bgImg = new Image(); bgImg.src = 'bg.jpg';
    const music = new Audio('music.mp3'); music.loop = true;

    let isPlaying = false, cameraX = 0, frame = 0, currentLvl = 0, attempts = 1;
    const player = { x: 100, y: 100, w: 50, h: 50, vx: 0, vy: 0, speed: 7, jump: -17, ground: false, angle: 0 };
    const input = { left: false, right: false, up: false };
    let npcs = [];

    // –ì–ï–ù–ï–†–ê–¶–ò–Ø 20 –†–ê–ó–ù–û–û–ë–†–ê–ó–ù–´–• –£–†–û–í–ù–ï–ô
    const levels = [];
    for(let i=0; i<20; i++) {
        const len = 3500 + (i * 500);
        const levelData = { width: len, p: [[0, 500, 800, 200]], l: [], s: [], npcs: [], g: [len - 150, 500] };
        
        for(let x = 850; x < len - 500; x += 450) {
            const y = 300 + Math.random() * 200;
            const w = 300 + Math.random() * 300;
            levelData.p.push([x, y, w, 40]);
            
            // –†–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–π
            const rand = Math.random();
            if(rand > 0.7) { // –õ–∞–∑–µ—Ä –≤ –≤–æ–∑–¥—É—Ö–µ (–Ω–æ—Ä–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä)
                levelData.l.push({ x: x + w/2 - 10, y: y - 80, w: 20, h: 80 }); 
            } else if(rand > 0.4) { // –®–∏–ø—ã –Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ
                levelData.s.push({ x: x + 50, y: y - 20, w: 40, h: 20 });
            }
            
            if(Math.random() > 0.4) levelData.npcs.push({ x: x + 20, y: y - 40, startX: x + 20, range: w - 50, dir: 1 });
        }
        levelData.p.push([len - 500, 500, 500, 200]);
        levels.push(levelData);
    }

    const grid = document.getElementById('lvlGrid');
    for(let i=0; i<20; i++) {
        const btn = document.createElement('button');
        btn.className = 'lvl-btn'; btn.innerText = i + 1;
        btn.onclick = () => startGame(i);
        grid.appendChild(btn);
    }

    function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
    window.addEventListener('resize', resize); resize();

    function startGame(idx) {
        currentLvl = idx; attempts = 1; reset();
        music.play().catch(() => {});
        document.getElementById('menu').classList.add('hidden');
        isPlaying = true; requestAnimationFrame(loop);
    }

    function reset(isDeath = false) {
        if(isDeath) attempts++;
        player.x = 100; player.y = 100; player.vx = 0; player.vy = 0; player.angle = 0;
        npcs = JSON.parse(JSON.stringify(levels[currentLvl].npcs));
        document.getElementById('attemptDisplay').innerText = `–ü–û–ü–´–¢–ö–ê: ${attempts}`;
    }

    // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ + –¢–∞—á)
    const setupBtn = (id, key) => {
        const el = document.getElementById(id);
        el.onpointerdown = (e) => { e.preventDefault(); input[key] = true; };
        el.onpointerup = (e) => { e.preventDefault(); input[key] = false; };
        el.onpointerleave = (e) => { e.preventDefault(); input[key] = false; };
    };
    setupBtn('lBtn', 'left'); setupBtn('rBtn', 'right'); setupBtn('jBtn', 'up');

    window.onkeydown = (e) => {
        if(e.code==='ArrowLeft'||e.code==='KeyA') input.left = true;
        if(e.code==='ArrowRight'||e.code==='KeyD') input.right = true;
        if(e.code==='ArrowUp'||e.code==='Space'||e.code==='KeyW') input.up = true;
    };
    window.onkeyup = (e) => {
        if(e.code==='ArrowLeft'||e.code==='KeyA') input.left = false;
        if(e.code==='ArrowRight'||e.code==='KeyD') input.right = false;
        if(e.code==='ArrowUp'||e.code==='Space'||e.code==='KeyW') input.up = false;
    };

    function loop() {
        if(!isPlaying) return;
        frame++;
        const lvl = levels[currentLvl];
        document.getElementById('lvlDisplay').innerText = `–≠–¢–ê–ñ: ${currentLvl+1}/20`;

        if(input.left) player.vx = -player.speed;
        else if(input.right) player.vx = player.speed;
        else player.vx *= 0.8;

        if(input.up && player.ground) { player.vy = player.jump; player.ground = false; }
        if(!player.ground) player.angle += 0.15; else player.angle = 0;

        player.vy += 0.8; player.x += player.vx; player.y += player.vy;
        cameraX += (player.x - canvas.width/3 - cameraX) * 0.1;
        if(cameraX < 0) cameraX = 0;

        player.ground = false;
        lvl.p.forEach(p => {
            if(player.x+player.w > p[0] && player.x < p[0]+p[2] && player.y+player.h > p[1] && player.y+player.h < p[1]+30 && player.vy >= 0) {
                player.y = p[1]-player.h; player.vy = 0; player.ground = true;
            }
        });

        npcs.forEach(n => {
            n.x += n.dir * 1.5;
            if(n.x > n.startX + n.range || n.x < n.startX) n.dir *= -1;
        });

        // –õ–ê–ó–ï–†–´: —Ç–µ–ø–µ—Ä—å —ç—Ç–æ –ª—É—á–∏ —Å–±–æ–∫—É –∏–ª–∏ —Å–≤–µ—Ä—Ö—É, –Ω–æ –∫–æ–Ω–µ—á–Ω–æ–π –¥–ª–∏–Ω—ã
        const active = (frame % 140) < 50; 
        if(active) {
            lvl.l.forEach(l => {
                if(player.x+player.w > l.x && player.x < l.x+l.w && player.y+player.h > l.y && player.y < l.y+l.h) reset(true);
            });
        }
        // –®–ò–ü–´: —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–∏ –Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞—Ö
        lvl.s.forEach(s => {
            if(player.x+player.w > s.x && player.x < s.x+s.w && player.y+player.h > s.y && player.y < s.y+s.h) reset(true);
        });

        if(player.x + player.w > lvl.g[0] && player.y + player.h > lvl.g[1]-100) {
            if(currentLvl < 19) { currentLvl++; attempts = 1; reset(); } 
            else { alert("–ü–û–ë–ï–î–ê! –í–´ –•–ê–ô–ü–ê–ù–£–õ–ò –ù–ê –ú–ê–ö–°–ò–ú–£–ú!"); location.reload(); }
        }
        if(player.y > canvas.height + 400) reset(true);

        draw(lvl, active);
        requestAnimationFrame(loop);
    }

    function draw(lvl, active) {
        ctx.fillStyle = '#0b0b10'; ctx.fillRect(0,0,canvas.width,canvas.height);
        ctx.globalAlpha = 0.25; ctx.drawImage(bgImg, 0, 0, canvas.width, canvas.height); ctx.globalAlpha = 1;

        ctx.save(); ctx.translate(-cameraX, 0);

        // –ü–ª–∞—Ç—Ñ–æ—Ä–º—ã
        ctx.fillStyle = '#1e1e2e';
        lvl.p.forEach(p => {
            ctx.fillRect(p[0], p[1], p[2], p[3]);
            ctx.strokeStyle = '#cba6f7'; ctx.lineWidth = 2; ctx.strokeRect(p[0], p[1], p[2], p[3]);
        });

        // –®–∏–ø—ã (–û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–æ–≤)
        ctx.fillStyle = '#f38ba8';
        lvl.s.forEach(s => {
            ctx.beginPath();
            ctx.moveTo(s.x, s.y + s.h);
            ctx.lineTo(s.x + s.w/2, s.y);
            ctx.lineTo(s.x + s.w, s.y + s.h);
            ctx.fill();
        });

        // –õ–∞–∑–µ—Ä—ã (–ö–æ—Ä–æ—Ç–∫–∏–µ –≤—Å–ø—ã—à–∫–∏)
        lvl.l.forEach(l => {
            ctx.fillStyle = active ? '#f38ba8' : 'rgba(255,255,255,0.05)';
            if(active) { ctx.shadowBlur = 15; ctx.shadowColor = '#f38ba8'; }
            ctx.fillRect(l.x, l.y, l.w, l.h);
            ctx.shadowBlur = 0;
        });

        // NPC
        npcs.forEach(n => { ctx.drawImage(pImg, n.x, n.y, 40, 40); });

        // –ü–æ—Ä—Ç–∞–ª
        ctx.fillStyle = '#a6e3a1'; ctx.shadowBlur = 20; ctx.shadowColor = '#a6e3a1';
        ctx.fillRect(lvl.g[0], lvl.g[1]-100, 60, 100); ctx.shadowBlur = 0;

        // –ò–≥—Ä–æ–∫
        ctx.save();
        ctx.translate(player.x + player.w/2, player.y + player.h/2);
        ctx.rotate(player.angle);
        ctx.drawImage(pImg, -player.w/2, -player.h/2, player.w, player.h);
        ctx.restore();

        ctx.restore();
    }
</script>
</body>
</html>
