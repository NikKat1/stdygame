<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>STADY DASH: CRYSTAL CLEAR</title>
    <style>
        :root { --main: #cba6f7; --bg: #0b0b10; --danger: #f38ba8; --accent: #a6e3a1; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: var(--bg); font-family: sans-serif; color: white; user-select: none; touch-action: none; }
        canvas { display: block; width: 100%; height: 100%; }
        
        /* Загрузчик */
        #loader { position: fixed; inset: 0; background: var(--bg); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 2000; }
        .bar-container { width: 220px; height: 8px; background: rgba(255,255,255,0.1); border-radius: 10px; margin-top: 20px; }
        #bar { width: 0%; height: 100%; background: var(--main); border-radius: 10px; transition: width 0.3s; box-shadow: 0 0 15px var(--main); }

        /* Меню */
        .overlay { position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; z-index: 1000; background: rgba(11, 11, 16, 0.85); backdrop-filter: blur(8px); }
        .panel { background: rgba(24, 24, 37, 0.9); padding: 40px; border-radius: 30px; border: 2px solid var(--main); text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .start-btn { background: var(--main); color: #11111b; border: none; padding: 18px 50px; font-size: 1.4rem; font-weight: 900; border-radius: 15px; cursor: pointer; transition: transform 0.2s; }
        .start-btn:active { transform: scale(0.95); }

        /* Статистика */
        .stats-box { position: fixed; top: 20px; left: 20px; z-index: 100; background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(5px); padding: 12px 20px; border-radius: 15px; border: 1px solid rgba(203, 166, 247, 0.3); pointer-events: none; }
        
        /* Кнопки */
        .controls { position: fixed; bottom: 40px; left: 0; width: 100%; display: flex; justify-content: space-between; padding: 0 30px; box-sizing: border-box; z-index: 500; pointer-events: none; }
        .btn-zone { pointer-events: auto; }
        .btn { width: 75px; height: 75px; background: rgba(255,255,255,0.15); backdrop-filter: blur(3px); border-radius: 20px; display: flex; align-items: center; justify-content: center; color: white; font-size: 2.2rem; border: 2px solid rgba(255,255,255,0.2); }
        .btn:active { background: rgba(255,255,255,0.3); }
        .btn-jump { border-radius: 50%; border-color: var(--main); width: 90px; height: 90px; background: rgba(203, 166, 247, 0.2); }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="loader">
        <div style="font-size: 1.8rem; font-weight: 900; color: var(--main); letter-spacing: 2px;">STADY DASH</div>
        <div class="bar-container"><div id="bar"></div></div>
    </div>

    <canvas id="game"></canvas>

    <div id="menu" class="overlay hidden">
        <div class="panel">
            <h1 style="margin: 0 0 20px 0; color: var(--main);">STADY DASH</h1>
            <button class="start-btn" id="mainStartBtn">ПОГНАЛИ!</button>
        </div>
    </div>

    <div class="stats-box">
        <div id="lvlDisplay" style="font-weight: bold; font-size: 1.1rem;">ЭТАЖ: 1/32</div>
        <div id="attemptDisplay" style="color: var(--danger); font-size: 0.9rem; margin-top: 4px;">ПОПЫТКА: 1</div>
    </div>

    <div class="controls">
        <div style="display:flex; gap:20px;">
            <div id="lBtn" class="btn-zone"><div class="btn">←</div></div>
            <div id="rBtn" class="btn-zone"><div class="btn">→</div></div>
        </div>
        <div id="jBtn" class="btn-zone"><div class="btn btn-jump">↑</div></div>
    </div>

<script>
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    
    const assets = {
        images: { player: 'player.jpg', npc: 'npc.png' },
        audio: { m1: 'music.mp3', m2: 'music2.mp3', jump: 'jump.wav', loose: 'loose.wav', fall: 'fall.wav' }
    };

    const loaded = { img: {}, snd: {} };
    const bgImg = new Image();
    let total = Object.keys(assets.images).length + Object.keys(assets.audio).length;
    let count = 0;

    function initPreload() {
        for (let k in assets.images) {
            let img = new Image();
            img.src = assets.images[k];
            img.onload = itemDone; img.onerror = itemDone;
            loaded.img[k] = img;
        }
        for (let k in assets.audio) {
            let snd = new Audio();
            snd.src = assets.audio[k];
            snd.oncanplaythrough = function cb() { itemDone(); snd.oncanplaythrough = null; };
            snd.onerror = itemDone;
            loaded.snd[k] = snd;
        }
    }

    function itemDone() {
        count++;
        document.getElementById('bar').style.width = (count/total)*100 + '%';
        if(count >= total) {
            setTimeout(() => {
                document.getElementById('loader').classList.add('hidden');
                document.getElementById('menu').classList.remove('hidden');
            }, 300);
        }
    }

    initPreload();

    let isPlaying = false, currentLvl = 0, attempts = 1, frame = 0;
    let cameraX = 0, cameraY = 0, zoom = 1.0, lastTime = 0;
    const player = { x: 100, y: 400, w: 42, h: 42, vx: 0, vy: 0, speed: 8.5, jump: -23.5, ground: false, angle: 0, coyote: 0, fallSnd: false };
    const input = { left: false, right: false, up: false };

    function playSfx(name) {
        if(!loaded.snd[name]) return;
        let s = loaded.snd[name].cloneNode();
        s.volume = 0.4; s.play().catch(()=>{});
    }

    function updateMusic() {
        [loaded.snd.m1, loaded.snd.m2].forEach(m => { if(m){m.pause(); m.currentTime = 0;} });
        let track = (currentLvl % 2 === 0) ? loaded.snd.m1 : loaded.snd.m2;
        if(track) { track.loop = true; track.play().catch(()=>{ loaded.snd.m2.play().catch(()=>{}); }); }
    }

    function startGame() {
        bgImg.src = `back (${(currentLvl % 32) + 1}).jpg`;
        levelData = generateLevel(currentLvl);
        player.x = 100; player.y = 400; player.vx = 0; player.vy = 0; player.angle = 0; player.fallSnd = false;
        document.getElementById('lvlDisplay').innerText = `ЭТАЖ: ${currentLvl+1}/32`;
        document.getElementById('attemptDisplay').innerText = `ПОПЫТКА: ${attempts}`;
        updateMusic();
        document.getElementById('menu').classList.add('hidden');
        if(!isPlaying) { isPlaying = true; requestAnimationFrame(loop); }
    }

    window.onkeydown = (e) => { 
        if(e.code==='ArrowLeft'||e.code==='KeyA') input.left = true;
        if(e.code==='ArrowRight'||e.code==='KeyD') input.right = true;
        if(e.code==='ArrowUp'||e.code==='Space'||e.code==='KeyW') input.up = true;
    };
    window.onkeyup = (e) => { 
        if(e.code==='ArrowLeft'||e.code==='KeyA') input.left = false;
        if(e.code==='ArrowRight'||e.code==='KeyD') input.right = false;
        if(e.code==='ArrowUp'||e.code==='Space'||e.code==='KeyW') input.up = false;
    };

    const bT = (id, k) => {
        let e = document.getElementById(id);
        e.ontouchstart = (ev) => { ev.preventDefault(); input[k] = true; };
        e.ontouchend = (ev) => { ev.preventDefault(); input[k] = false; };
    };
    bT('lBtn','left'); bT('rBtn','right'); bT('jBtn','up');

    let levelData = { p: [], g: [0,0], s: [], l: [], npcs: [] };
    function generateLevel(idx) {
        let len = 5000 + (idx * 400), p = [{x:0, y:600, w:600, h:400, m:false}], s=[], l=[], npcs=[], lx=600, ly=600;
        while(lx < len - 900) {
            lx += 240 + Math.random()*100;
            ly = Math.max(300, Math.min(1000, ly + (Math.random()-0.5)*250));
            let w = 280 + Math.random()*80, mv = Math.random()>0.7;
            let plat = { x:lx, y:ly, w:w, h:50, m:mv, off:Math.random()*10, bY:ly };
            p.push(plat);
            if(!mv) {
                if(Math.random()>0.5) s.push({x:lx+w/2-25, y:ly-25, w:50, h:25});
                npcs.push({x:lx+20, y:ly-40, w:35, h:40, par:plat, relX:Math.random()*(w-40), dir:1});
            } else if(Math.random()>0.6) {
                l.push({x:lx+w/2-10, y:ly-220, w:20, h:220});
            }
            lx += w;
        }
        p.push({x:len-700, y:ly, w:700, h:500, m:false});
        return { p, s, l, npcs, g:[len-150, ly] };
    }

    function loop(t) {
        if(!isPlaying) return;
        requestAnimationFrame(loop);
        if(t - lastTime < 16) return;
        lastTime = t; frame++;
        let lon = (frame % 140) < 80;

        if(player.ground) { player.coyote=8; player.fallSnd=false; } else if(player.coyote>0) player.coyote--;
        if(!player.ground && player.y>1500 && !player.fallSnd) { playSfx('fall'); player.fallSnd=true; }
        if(input.up && player.coyote>0) { player.vy=player.jump; player.ground=false; player.coyote=0; playSfx('jump'); }

        player.vx = input.left ? -player.speed : (input.right ? player.speed : 0);
        player.vy += 1.1; player.x += player.vx; player.y += player.vy;
        player.angle = player.ground ? 0 : player.angle + 0.22;

        player.ground = false;
        levelData.p.forEach(p => {
            if(p.m) p.y = p.bY + Math.sin(frame*0.05 + p.off)*80;
            if(player.x+player.w > p.x && player.x < p.x+p.w && player.y+player.h > p.y && player.y+player.h < p.y+40 && player.vy>=0) {
                player.y = p.y-player.h; player.vy=0; player.ground=true;
            }
        });

        levelData.npcs.forEach(n => {
            n.relX += n.dir*2.2; if(n.relX<0 || n.relX>n.par.w-n.w) n.dir*=-1;
            n.x = n.par.x+n.relX; n.y = n.par.y-n.h;
        });

        levelData.s.forEach(s => { if(player.x+player.w-10>s.x && player.x+10<s.x+s.w && player.y+player.h>s.y) { attempts++; startGame(); playSfx('loose'); } });
        if(lon) levelData.l.forEach(l => { if(player.x+player.w>l.x && player.x<l.x+l.w && player.y+player.h>l.y && player.y<l.y+l.h) { attempts++; startGame(); playSfx('loose'); } });
        
        if(player.y>2800) { attempts++; startGame(); }
        if(player.x > levelData.g[0]) { currentLvl++; startGame(); }

        let tZ = 1.0, nP = levelData.p.find(p=>p.x > player.x && p.x < player.x+600);
        if(nP) tZ = Math.max(0.7, 1.0 - Math.abs(player.y-nP.y)/1200);
        zoom += (tZ - zoom)*0.05;
        cameraX += (player.x - (canvas.width/zoom)*0.3 - cameraX)*0.1;
        cameraY += (player.y - (canvas.height/zoom)*0.6 - cameraY)*0.08;
        
        draw(lon);
    }

    function draw(lon) {
        let w = canvas.width, h = canvas.height;
        ctx.setTransform(1,0,0,1,0,0);
        ctx.fillStyle = '#0b0b10'; ctx.fillRect(0,0,w,h);
        
        ctx.save();
        ctx.translate(w/2, h/2); ctx.scale(zoom, zoom); ctx.translate(-w/2, -h/2);
        
        // ПРОЗРАЧНОСТЬ ФОНА ТЕПЕРЬ 0.7 (БЫЛО 0.3)
        ctx.globalAlpha = 0.7; 
        ctx.drawImage(bgImg, -(cameraX*0.15)%w, -(cameraY*0.15)%h, w, h);
        ctx.drawImage(bgImg, -(cameraX*0.15)%w + w, -(cameraY*0.15)%h, w, h);
        
        ctx.translate(-cameraX, -cameraY);
        ctx.globalAlpha = 1.0;

        levelData.p.forEach(p => {
            ctx.fillStyle = p.m ? '#24283b' : '#1e1e2e'; 
            ctx.fillRect(p.x, p.y, p.w, p.h);
            ctx.strokeStyle = 'rgba(203, 166, 247, 0.6)'; 
            ctx.lineWidth = 2; ctx.strokeRect(p.x, p.y, p.w, p.h);
        });
        
        ctx.fillStyle = '#f38ba8';
        levelData.s.forEach(s => { 
            ctx.beginPath(); ctx.moveTo(s.x, s.y+s.h); ctx.lineTo(s.x+s.w/2, s.y); ctx.lineTo(s.x+s.w, s.y+s.h); ctx.fill(); 
        });

        // ПРОЗРАЧНОСТЬ ЛАЗЕРОВ
        levelData.l.forEach(l => {
            ctx.fillStyle = lon ? 'rgba(243, 139, 168, 0.8)' : 'rgba(243, 139, 168, 0.15)';
            ctx.fillRect(l.x, l.y, l.w, l.h);
            if(lon) {
                ctx.shadowBlur = 20; ctx.shadowColor = '#f38ba8';
                ctx.fillStyle = '#fff'; ctx.fillRect(l.x+l.w/2-1, l.y, 2, l.h);
                ctx.shadowBlur = 0;
            }
        });

        levelData.npcs.forEach(n => {
            ctx.save(); ctx.translate(n.x+n.w/2, n.y+n.h/2); if(n.dir<0) ctx.scale(-1,1);
            ctx.drawImage(loaded.img.npc, -n.w/2, -n.h/2, n.w, n.h); ctx.restore();
        });

        ctx.fillStyle = '#a6e3a1'; ctx.shadowBlur = 10; ctx.shadowColor = '#a6e3a1';
        ctx.fillRect(levelData.g[0], levelData.g[1]-120, 60, 120); ctx.shadowBlur = 0;
        
        ctx.save(); ctx.translate(player.x+player.w/2, player.y+player.h/2); ctx.rotate(player.angle);
        ctx.drawImage(loaded.img.player, -player.w/2, -player.h/2, player.w, player.h);
        ctx.restore(); ctx.restore();
    }

    window.onresize = () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; };
    window.onresize();
    
    document.getElementById('mainStartBtn').onclick = () => {
        // Разблокировка звука для iOS/Android
        for(let k in loaded.snd) { let s = loaded.snd[k]; s.play().then(()=>s.pause()).catch(()=>{}); }
        startGame();
    };
</script>
</body>
</html>
