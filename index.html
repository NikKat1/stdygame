<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>STADY DASH 3D: GITHUB FIX</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: sans-serif; }
        #ui { position: fixed; top: 20px; left: 20px; color: #cba6f7; z-index: 10; pointer-events: none; }
        
        #muteBtn { 
            position: fixed; top: 20px; right: 20px; z-index: 20;
            width: 50px; height: 50px; background: rgba(203, 166, 247, 0.3);
            border: 2px solid #cba6f7; border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; font-size: 1.5rem; color: white;
        }

        .controls { position: fixed; bottom: 30px; width: 100%; display: flex; justify-content: space-around; z-index: 10; padding: 0 10px; box-sizing: border-box; }
        .btn { width: 75px; height: 75px; background: rgba(203, 166, 247, 0.2); border: 2px solid #cba6f7; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 2rem; pointer-events: auto; cursor: pointer; user-select: none; }
        
        #bg-container { 
            position: fixed; inset: 0; z-index: -1; 
            background-size: 100% 100%; background-repeat: no-repeat;
            background-position: center; filter: brightness(0.5); 
            transition: background-image 0.4s ease; 
        }

        #start-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); display: flex; align-items: center; justify-content: center; z-index: 100; text-align: center; }
        .play-btn { background: #cba6f7; color: #111; border: none; padding: 20px 60px; font-size: 2rem; border-radius: 20px; font-weight: 900; cursor: pointer; box-shadow: 0 0 20px #cba6f7; }
    </style>
</head>
<body>

<div id="start-overlay">
    <div>
        <h1 style="color:white; margin-bottom:10px;">STADY DASH 3D</h1>
        <p style="color:#cba6f7; margin-bottom:30px;">–°—Ç—Ä–µ–ª–∫–∏/WASD –¥–ª—è –ü–ö</p>
        <button class="play-btn" id="playBtn">–ò–ì–†–ê–¢–¨</button>
    </div>
</div>

<div id="muteBtn">üîä</div>
<div id="bg-container"></div>

<div id="ui">
    <b id="lvlTxt" style="font-size: 1.5rem;">–≠–¢–ê–ñ: 1</b><br>
    <span id="attTxt" style="color:#f38ba8; font-weight:bold;">–ü–û–ü–´–¢–ö–ê: 1</span>
</div>

<div class="controls">
    <div id="lBtn" class="btn">‚Üê</div>
    <div id="jBtn" class="btn" style="width:95px; height:95px;">‚Üë</div>
    <div id="rBtn" class="btn">‚Üí</div>
</div>

<script type="importmap">
  { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }
</script>

<script type="module">
    import * as THREE from 'three';

    const scene = new THREE.Scene();
    const aspect = window.innerWidth / window.innerHeight;
    const d = 8;
    const camera = new THREE.OrthographicCamera(-d * aspect, d * aspect, d, -d, 1, 1000);
    camera.position.set(20, 15, 20);
    camera.lookAt(0, 0, 0);

    const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    document.body.appendChild(renderer.domElement);

    const listener = new THREE.AudioListener();
    camera.add(listener);
    const audioLoader = new THREE.AudioLoader();
    
    let isMuted = false;
    let currentMusic = null;

    // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–ª—è GitHub
    function loadSnd(file, loop = false, vol = 0.4) {
        const s = new THREE.Audio(listener);
        audioLoader.load('./' + file, 
            buffer => { s.setBuffer(buffer); s.setLoop(loop); s.setVolume(vol); console.log('Loaded:', file); },
            undefined, 
            err => console.warn('Sound error:', file)
        );
        return s;
    }

    const sfxJump = loadSnd('jump.wav');
    const sfxLoose = loadSnd('loose.wav');
    const sfxFall = loadSnd('fall.wav');
    const m1 = loadSnd('music.mp3', true, 0.3);
    const m2 = loadSnd('music2.mp3', true, 0.3);

    const loader = new THREE.TextureLoader();
    const texP = loader.load('./player.jpg');
    const texN = loader.load('./npc.png');

    scene.add(new THREE.AmbientLight(0xffffff, 1.2));
    const light = new THREE.DirectionalLight(0xffffff, 1);
    light.position.set(10, 20, 10);
    scene.add(light);

    let player = { x: 0, y: 5, z: 0, vx: 0, vy: 0, ground: false, lvl: 0, att: 1, mesh: null, fallSnd: false };
    player.mesh = new THREE.Mesh(new THREE.BoxGeometry(1, 1, 1), new THREE.MeshStandardMaterial({ map: texP }));
    scene.add(player.mesh);

    let platforms = [], obstacles = [], npcs = [];
    let input = { left: false, right: false, up: false };

    function createLevel() {
        [...platforms, ...obstacles, ...npcs].forEach(o => scene.remove(o.mesh || o));
        platforms = []; obstacles = []; npcs = [];
        document.getElementById('bg-container').style.backgroundImage = `url('./back (${Math.floor(Math.random()*32)+1}).jpg')`;
        
        addPlatform(0, 0, 0, 6);
        let cx = 0, cy = 0;
        for(let i = 0; i < 12; i++) {
            cx += 5 + Math.random() * 2;
            cy += (Math.random() - 0.5) * 4;
            let moving = Math.random() > 0.7;
            let p = addPlatform(cx, cy, 0, 4, false, moving);
            if(!moving) {
                if(Math.random() > 0.4) addObstacle(cx, cy + 0.7, 0);
                if(Math.random() > 0.5) addNPC(cx, cy + 0.8, 0, p);
            }
        }
        addPlatform(cx + 6, cy, 0, 5, true);
        
        if (currentMusic) currentMusic.stop();
        currentMusic = (player.lvl % 2 === 0) ? m1 : m2;
        if (!isMuted && currentMusic.buffer) currentMusic.play();
    }

    function addPlatform(x, y, z, size, finish = false, moving = false) {
        const mesh = new THREE.Mesh(
            new THREE.BoxGeometry(size, 0.6, 3),
            new THREE.MeshStandardMaterial({ color: finish ? 0xa6e3a1 : (moving ? 0x89b4fa : 0x313244) })
        );
        mesh.position.set(x, y, z);
        scene.add(mesh);
        const p = { mesh, x, y, z, size, finish, moving, offset: Math.random() * 10 };
        platforms.push(p);
        return p;
    }

    function addObstacle(x, y, z) {
        const mesh = new THREE.Mesh(new THREE.ConeGeometry(0.4, 0.8, 4), new THREE.MeshStandardMaterial({ color: 0xf38ba8 }));
        mesh.position.set(x, y, z);
        scene.add(mesh);
        obstacles.push(mesh);
    }

    function addNPC(x, y, z, parent) {
        const mesh = new THREE.Mesh(new THREE.PlaneGeometry(0.9, 0.9), new THREE.MeshStandardMaterial({ map: texN, transparent: true, side: THREE.DoubleSide }));
        mesh.rotation.y = Math.PI / 4;
        scene.add(mesh);
        npcs.push({ mesh, parent, relX: 0, dir: 1 });
    }

    // –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞
    window.addEventListener('keydown', (e) => {
        if (['ArrowLeft', 'a', 'A'].includes(e.key)) input.left = true;
        if (['ArrowRight', 'd', 'D'].includes(e.key)) input.right = true;
        if (['ArrowUp', 'w', 'W', ' '].includes(e.key)) input.up = true;
    });
    window.addEventListener('keyup', (e) => {
        if (['ArrowLeft', 'a', 'A'].includes(e.key)) input.left = false;
        if (['ArrowRight', 'd', 'D'].includes(e.key)) input.right = false;
        if (['ArrowUp', 'w', 'W', ' '].includes(e.key)) input.up = false;
    });

    document.getElementById('muteBtn').onclick = () => {
        isMuted = !isMuted;
        document.getElementById('muteBtn').innerText = isMuted ? 'üîá' : 'üîä';
        if (currentMusic) isMuted ? currentMusic.stop() : currentMusic.play();
    };

    function update() {
        player.vx = input.left ? -0.16 : (input.right ? 0.16 : player.vx * 0.85);
        if(input.up && player.ground) { 
            player.vy = 0.38; player.ground = false; 
            if(sfxJump.buffer && !sfxJump.isPlaying) sfxJump.play();
        }
        
        player.vy -= 0.018;
        player.x += player.vx;
        player.y += player.vy;

        if(player.y < -5 && !player.fallSnd) {
            if(sfxFall.buffer && !sfxFall.isPlaying) sfxFall.play();
            player.fallSnd = true;
        }

        platforms.forEach(p => {
            if(p.moving) p.mesh.position.y = p.y + Math.sin(Date.now() * 0.003 + p.offset) * 1.5;
            let py = p.moving ? p.mesh.position.y : p.y;
            if(Math.abs(player.x - p.x) < p.size/2 + 0.4 && player.y - 0.5 < py + 0.3 && player.vy <= 0 && player.y > py) {
                player.y = py + 0.8; player.vy = 0; player.ground = true; player.fallSnd = false;
                if(p.finish) { player.lvl++; createLevel(); resetPlayer(); }
            }
        });

        npcs.forEach(n => {
            n.relX += 0.04 * n.dir;
            if(Math.abs(n.relX) > n.parent.size/2 - 0.5) n.dir *= -1;
            n.mesh.position.set(n.parent.x + n.relX, (n.parent.moving ? n.parent.mesh.position.y : n.parent.y) + 0.8, 0);
        });

        obstacles.forEach(s => { if(player.mesh.position.distanceTo(s.position) < 0.8) die(); });
        if(player.y < -12) die();

        player.mesh.position.set(player.x, player.y, player.z);
        player.mesh.rotation.z -= player.vx * 0.5;
        camera.position.x = player.x + 12;
        camera.lookAt(player.x, player.y, 0);
    }

    function die() { 
        if(sfxLoose.buffer && !sfxLoose.isPlaying) sfxLoose.play();
        player.att++; resetPlayer(); createLevel(); 
    }

    function resetPlayer() { 
        player.x = 0; player.y = 5; player.vx = 0; player.vy = 0; player.fallSnd = false;
        document.getElementById('attTxt').innerText = `–ü–û–ü–´–¢–ö–ê: ${player.att}`;
        document.getElementById('lvlTxt').innerText = `–≠–¢–ê–ñ: ${player.lvl + 1}`;
    }

    document.getElementById('playBtn').onclick = () => {
        document.getElementById('start-overlay').style.display = 'none';
        const context = THREE.AudioContext.getContext();
        if (context.state === 'suspended') context.resume();
        createLevel();
        animate();
    };

    const btn = (id, k) => {
        const e = document.getElementById(id);
        e.onmousedown = e.ontouchstart = (ev) => { ev.preventDefault(); input[k] = true; };
        e.onmouseup = e.onmouseleave = e.ontouchend = () => input[k] = false;
    };
    btn('lBtn', 'left'); btn('rBtn', 'right'); btn('jBtn', 'up');

    function animate() { requestAnimationFrame(animate); update(); renderer.render(scene, camera); }

    window.onresize = () => {
        const aspect = window.innerWidth / window.innerHeight;
        camera.left = -d * aspect; camera.right = d * aspect;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    };
</script>
</body>
</html>
